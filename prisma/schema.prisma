// ======================
// GENERATOR + DATABASE
// ======================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ======================
// COMPANY
// ======================
model Company {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  companyName        String
  logo               String?
  subscriptionType   String   @default("Basic")
  subscriptionExpiry DateTime
  status             String   @default("active")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  users              User[]
  clients            Client[]
  commissions        Commission[]
  otps               OTP[]
  invoices           Invoice[]

  @@index([status])
  @@index([subscriptionExpiry])
}

// ======================
// USER
// ======================
model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  phone        String   @unique
  email        String   @unique
  password     String
  role         String   @default("user")
  companyId    String?  @db.ObjectId
  profilePhoto String?
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company      Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clients      Client[]
  commissions  Commission[]

  @@index([companyId])
  @@index([role])
}

// ======================
// CLIENT
// ======================
model Client {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  clientName        String
  phone             String
  email             String?
  companyName       String?
  requirementType   String
  inquiryType       String
  budget            Float?
  preferredLocation String?
  address           String?
  visitingDate      DateTime?
  visitingTime      String?
  followUpDate      DateTime?
  status            String   @default("New")
  source            String?
  notes             String?
  companyId         String   @db.ObjectId
  createdBy         String   @db.ObjectId
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator           User     @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  commissions       Commission[]

  @@index([companyId])
  @@index([createdBy])
  @@index([status])
  @@index([visitingDate])
  @@index([phone])
}

// ======================
// COMMISSION
// ======================
model Commission {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  clientId             String   @db.ObjectId
  userId               String   @db.ObjectId
  companyId            String   @db.ObjectId
  dealAmount           Float
  commissionPercentage Float
  commissionAmount     Float
  paidStatus           String   @default("Pending")
  paymentDate          DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  client               Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Restrict)
  company              Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([clientId])
  @@index([paidStatus])
}

// ======================
// SECURE OTP (UPDATED)
// ======================
model OTP {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  phone      String
  companyId  String   @db.ObjectId
  otpHash    String
  attempts   Int      @default(0)
  ipAddress  String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([phone, companyId])
  @@index([expiresAt])
}

// ======================
// INVOICE
// ======================
model Invoice {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  companyId         String   @db.ObjectId
  invoiceNumber     String   @unique
  amount            Float
  paymentStatus     String   @default("pending")
  planType          String
  razorpayOrderId   String?
  razorpayPaymentId String?
  validFrom         DateTime
  validUpto         DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([paymentStatus])
}